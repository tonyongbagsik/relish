<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="manifest" href="manifest.json">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>Relish Bar Recorder</title>
  <style>
    :root { --bg:#0b1220; --card:#0f172a; --accent:#0ea5e9; --text:#e2e8f0; --muted:#94a3b8; --danger:#ef4444; --ok:#22c55e; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#111827);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;color:var(--text);min-height:100svh;padding:24px}
    h2{margin:0 0 16px;font-weight:700;letter-spacing:.2px}
    .card{max-width:460px;margin:auto;background:var(--card);border:1px solid #1f2937;border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,.35);padding:18px}
    label{display:block;margin:14px 0 6px;font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    input,select{width:100%;background:#0b1324;border:1px solid #263143;color:var(--text);border-radius:10px;padding:10px 12px;font-size:15px;outline:none}
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(14,165,233,.15)}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .unit{align-self:center;font-size:13px;color:var(--muted)}
    button.primary{width:100%;background:var(--accent);color:#00131a;border:none;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer;margin-top:14px}
    button.primary:hover{filter:brightness(1.05)}
    .sep{height:1px;background:#1f2937;margin:24px 0}
    .muted{color:var(--muted);font-size:13px}
    .toolbar{display:flex;gap:10px}
    .ghost{background:transparent;border:1px solid #334155;color:var(--text);border-radius:10px;padding:10px 12px;cursor:pointer}
    .ghost:hover{border-color:#475569}
    /* Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(2,6,23,.66);place-items:center;z-index:50;padding:16px}
    .sheet{width:min(520px,96vw);background:#0d1528;border:1px solid #1f2937;border-radius:16px;box-shadow:0 10px 50px rgba(0,0,0,.5);padding:16px}
    .itemrow{display:grid;grid-template-columns:20px 1fr 90px;gap:10px;align-items:center;margin:6px 0}
    .danger{background:var(--danger);color:white;border:none;border-radius:10px;padding:10px 12px;cursor:pointer}
    .danger[disabled]{opacity:.6;cursor:not-allowed}
    /* Install FAB */
    #installFab{position:fixed;right:16px;bottom:16px;background:#22d3ee;color:#002a30;border:none;padding:12px 14px;border-radius:999px;font-weight:700;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none;z-index:60;cursor:pointer}
    #installFab:hover{filter:brightness(1.05)}
  </style>
</head>
<body>

  <div class="card">
    <h2>Staff Daily Consumption</h2>

    <form id="consumptionForm" autocomplete="off">
      <label>Date</label>
      <input type="date" id="date" required />

      <label>Staff</label>
      <select id="staff" required>
        <option value="">— Select Staff —</option>
      </select>

      <label>Item</label>
      <select id="item" required>
        <option value="">— Select Item —</option>
      </select>

      <div class="row2">
        <div>
          <label>Quantity</label>
          <input type="number" id="quantity" min="1" required />
        </div>
        <div class="unit" id="unitLabel"></div>
      </div>

      <label>Reason</label>
      <select id="reason" required>
        <option value="">— Select Reason —</option>
        <option value="Pay Later">Pay Later</option>
        <option value="Complimentary">Complimentary</option>
        <option value="Personal Use">Personal Use</option>
      </select>

      <button type="submit" class="primary" id="submitBtn">Submit</button>
      <div class="muted">Works offline. Syncs when you’re back online.</div>
    </form>

    <div class="sep"></div>

    <div class="toolbar">
      <button class="ghost" id="eraseOpenBtn">Erase / Adjust Items</button>
      <button class="ghost" id="refreshListsBtn" title="Reload staff & items">↻ Refresh Lists</button>
    </div>
  </div>

  <!-- Erase / Adjust Modal -->
  <div class="modal" id="eraseModal">
    <div class="sheet">
      <h3 style="margin:6px 0 10px">Erase / Adjust</h3>

      <label>Staff</label>
      <select id="eraseStaff"></select>

      <div id="eraseItems" style="max-height:300px;overflow:auto;margin-top:8px"></div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="danger" id="eraseSubmit" disabled>Submit Erase</button>
        <button class="ghost" id="eraseClose">Cancel</button>
      </div>
      <div class="muted" style="margin-top:6px">Only items with positive net usage are shown. You can erase up to the remaining amount.</div>
    </div>
  </div>

  <!-- Install FAB -->
  <button id="installFab">Install App</button>

<script>
/* ==== CONFIG ==== */
const baseApiUrl = 'https://script.google.com/macros/s/AKfycbxuZrK2k-iL7fAF-xQpWz2PQCf5QndggQZ26OqCoW--f6RHpVYegu-bN0e2Ksskzf68iw/exec'; // <-- paste GAS web app https://script.google.com/macros/s/xxx/exec

/* ==== ELEMENTS ==== */
const form = document.getElementById('consumptionForm');
const unitLabel = document.getElementById('unitLabel');
const staffSel = document.getElementById('staff');
const itemSel  = document.getElementById('item');
const qtyInput = document.getElementById('quantity');
const reasonSel= document.getElementById('reason');
const submitBtn= document.getElementById('submitBtn');

const eraseOpenBtn = document.getElementById('eraseOpenBtn');
const eraseModal   = document.getElementById('eraseModal');
const eraseStaff   = document.getElementById('eraseStaff');
const eraseItemsDiv= document.getElementById('eraseItems');
const eraseSubmit  = document.getElementById('eraseSubmit');
const eraseClose   = document.getElementById('eraseClose');

const refreshListsBtn = document.getElementById('refreshListsBtn');
const installFab = document.getElementById('installFab');

/* ==== STATE ==== */
let itemsData = []; // [[item,unit], ...]
let deferredPrompt = null;

/* ==== LOADERS ==== */
async function loadStaff(){
  const data = await fetch(baseApiUrl + '?type=staff').then(r=>r.json()).catch(()=>[]);
  const opts = ['<option value="">— Select Staff —</option>'].concat(data.map(n=>`<option>${n}</option>`)).join('');
  staffSel.innerHTML = opts;
  eraseStaff.innerHTML = '<option value="">— Select Staff —</option>' + data.map(n=>`<option>${n}</option>`).join('');
}

async function loadItems(){
  itemsData = await fetch(baseApiUrl + '?type=items').then(r=>r.json()).catch(()=>[]);
  const opts = ['<option value="">— Select Item —</option>'].concat(itemsData.map(r=>`<option>${r[0]}</option>`)).join('');
  itemSel.innerHTML = opts;
}

function updateUnitLabel(){
  const v = itemSel.value;
  const match = itemsData.find(r=>r[0]===v);
  unitLabel.textContent = match ? match[1] : '';
}

/* ==== INIT ==== */
window.addEventListener('load', async () => {
  await Promise.all([loadStaff(), loadItems()]);
  updateUnitLabel();
});

/* Refresh on demand (if may binago ka sa sheet) */
refreshListsBtn.addEventListener('click', async ()=>{
  await Promise.all([loadStaff(), loadItems()]);
  updateUnitLabel();
});

/* Also refresh staff list when opening the dropdown */
staffSel.addEventListener('pointerdown', loadStaff);

/* Unit change on item select */
itemSel.addEventListener('change', updateUnitLabel);

/* ==== SUBMIT (ADD) ==== */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  submitBtn.disabled = true; submitBtn.textContent = 'Submitting...';

  const payload = new URLSearchParams({
    action: 'add',
    date: document.getElementById('date').value,
    staff: staffSel.value,
    item:  itemSel.value,
    quantity: qtyInput.value,
    reason: reasonSel.value
  });

  try{
    if (navigator.onLine){
      const r = await fetch(baseApiUrl, {method:'POST', body: payload});
      if (!r.ok) throw new Error('HTTP '+r.status);
      alert('Saved!');
    }else{
      const q = JSON.parse(localStorage.getItem('offlineAdd')||'[]');
      q.push(Object.fromEntries(payload));
      localStorage.setItem('offlineAdd', JSON.stringify(q));
      alert('Offline → queued. Will sync when online.');
    }
    form.reset(); unitLabel.textContent='';
  }catch(err){
    alert('Submit failed.');
  }finally{
    submitBtn.disabled=false; submitBtn.textContent='Submit';
  }
});

/* ==== ONLINE SYNC ==== */
window.addEventListener('online', async ()=>{
  // adds
  const adds = JSON.parse(localStorage.getItem('offlineAdd')||'[]');
  for (const a of adds){
    await fetch(baseApiUrl, {method:'POST', body: new URLSearchParams(a)});
  }
  if (adds.length) localStorage.removeItem('offlineAdd');

  // erases
  const ers = JSON.parse(localStorage.getItem('offlineErase')||'[]');
  for (const er of ers){
    await fetch(baseApiUrl, {method:'POST', body: new URLSearchParams({action:'erase', staff:er.staff, items: JSON.stringify(er.items)})});
  }
  if (ers.length) localStorage.removeItem('offlineErase');
});

/* ==== ERASE / ADJUST ==== */
eraseOpenBtn.addEventListener('click', async ()=>{
  eraseSubmit.disabled = true;
  await loadStaff();
  eraseItemsDiv.innerHTML = '';
  eraseModal.style.display='grid';
});

eraseStaff.addEventListener('change', async ()=>{
  eraseSubmit.disabled = true;
  eraseItemsDiv.innerHTML = ''; // clear old items
  const s = eraseStaff.value;
  if (!s) return;

  // fetch fresh balances
  let list = [];
  try {
    list = await fetch(baseApiUrl+'?type=balances&staff='+encodeURIComponent(s))
              .then(r=>r.json());
  } catch(e){
    console.error('Failed to load balances', e);
  }

  if (!list.length){
    eraseItemsDiv.innerHTML = '<div class="muted">No items to erase.</div>';
    return;
  }

  // Render fresh list
  eraseItemsDiv.innerHTML = '';
  list.forEach(p=>{
    const row = document.createElement('div');
    row.className = 'itemrow';
    row.innerHTML = `
      <input type="checkbox" class="chk" value="${p.item}" data-max="${p.quantity}">
      <div>${p.item} <span class="muted">(${p.quantity} ${p.unit||''})</span></div>
      <input type="number" class="q" min="1" max="${p.quantity}" placeholder="Qty" disabled>
    `;
    eraseItemsDiv.appendChild(row);
  });
});


eraseItemsDiv.addEventListener('change', e=>{
  if (e.target.classList.contains('chk')){
    const row=e.target.closest('.itemrow');
    const q=row.querySelector('.q');
    q.disabled=!e.target.checked; if (!e.target.checked){ q.value=''; }
  }
  toggleEraseSubmit_();
});
eraseItemsDiv.addEventListener('input', e=>{
  if (!e.target.classList.contains('q')) return;
  const max = Number(e.target.getAttribute('max'))||0;
  let v = Number(e.target.value)||0;
  if (v>max){ v=max; e.target.value=v; }
  toggleEraseSubmit_();
});
function toggleEraseSubmit_(){
  let ok=false;
  [...eraseItemsDiv.querySelectorAll('.itemrow')].forEach(r=>{
    const c=r.querySelector('.chk'); const q=r.querySelector('.q');
    if (c.checked && Number(q.value)>0) ok=true;
  });
  eraseSubmit.disabled=!ok;
}

eraseSubmit.addEventListener('click', async ()=>{
  const staff = eraseStaff.value;
  if (!staff){ alert('Pick staff'); return; }
  const items=[];
  [...eraseItemsDiv.querySelectorAll('.itemrow')].forEach(r=>{
    const c=r.querySelector('.chk'); const q=r.querySelector('.q');
    if (c.checked){ items.push({item:c.value, quantity: Number(q.value)||0}); }
  });
  if (!items.length){ alert('Select at least one item'); return; }

  eraseSubmit.disabled=true; eraseSubmit.textContent='Erasing...';
  try{
    if (navigator.onLine){
      await fetch(baseApiUrl, {method:'POST', body:new URLSearchParams({action:'erase', staff, items: JSON.stringify(items)})});
      alert('Erase done.');
    }else{
      const q = JSON.parse(localStorage.getItem('offlineErase')||'[]');
      q.push({staff, items}); localStorage.setItem('offlineErase', JSON.stringify(q));
      alert('Offline → queued erase.');
    }
    eraseModal.style.display='none';
  }catch(e){
    alert('Erase failed.');
  }finally{
    eraseSubmit.disabled=false; eraseSubmit.textContent='Submit Erase';
  }
});
eraseClose.addEventListener('click', ()=> eraseModal.style.display='none');

/* ==== PWA INSTALL ==== */
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  installFab.style.display='inline-flex';
});
installFab.addEventListener('click', async ()=>{
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const choice = await deferredPrompt.userChoice;
  if (choice && choice.outcome!=='dismissed'){ installFab.style.display='none'; }
  deferredPrompt = null;
});

/* ==== SW REGISTER ==== */
if ('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('serviceworker.js')
      .then(reg=>console.log('SW:', reg.scope))
      .catch(err=>console.error('SW fail:', err));
  });
}
 // Refresh buong page every 60 seconds (1 minute)
  setTimeout(function() {
    location.reload();
  }, 60000);
  
</script>
</body>
</html>




