<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Staff Consumption Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0078d4" />
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background:#f8f9fa; padding:20px; margin:0; }
    h2 { text-align:center; color:#333; }
    form { max-width:400px; margin:auto; background:#fff; padding:1.5rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
    label { display:block; margin-top:15px; font-weight:600; font-size:0.9rem; color:#333; }
    input, select, textarea { width:100%; padding:0.45rem 0.5rem; margin-top:5px; border:1px solid #ccc; border-radius:5px; font-size:1rem; box-sizing:border-box; transition:border-color 0.2s; }
    input:focus, select:focus, textarea:focus { border-color:#0078d4; outline:none; }
    .quantity-unit { display:flex; align-items:center; gap:0.5rem; }
    .quantity-unit input { flex:1; }
    .unit-label { white-space:nowrap; font-size:0.9rem; color:#555; min-width:40px; }
    form button[type="submit"] { width:100%; background:orange; color:white; border:none; padding:0.7rem; border-radius:5px; font-size:1.1rem; margin-top:15px; margin-bottom:15px; cursor:pointer; transition:background 0.3s; position:relative; z-index:10; }
    form button[type="submit"]:hover { background:#e69500; }
    .section-separator { max-width:400px; margin:30px auto; border-top:2px solid #ddd; }
    #erasePayLaterContainer { max-width:400px; margin:20px auto; position:relative; z-index:1; }
    #erasePayLaterBtn { width:100%; background:#dc3545; color:#fff; border:none; padding:0.7rem; border-radius:5px; font-size:1.1rem; cursor:pointer; transition:background 0.3s; }
    #erasePayLaterBtn:hover { background:#b02a37; }
    #eraseModal { display:none; position:fixed; top:20%; left:50%; transform: translateX(-50%); background:#fff; padding:20px; border:1px solid #ccc; z-index:1000; max-height:70%; overflow-y:auto; width:90%; max-width:400px; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.2); }
    #payLaterItems .row { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
    #payLaterItems .row label { flex:1; margin:0; font-weight:500; }
    #payLaterItems .row input[type="number"] { width:70px; }
    @media (max-width: 480px) { form { padding:1rem; } }
  </style>
</head>
<body>

  <h2>Staff Daily Consumption</h2>

  <!-- Form Section -->
  <form id="consumptionForm">
    <label for="date">Date</label>
    <input type="date" id="date" name="date" required />

    <label for="staff">Staff</label>
    <select id="staff" name="staff" required>
      <option value="">--Select Staff--</option>
    </select>

    <label for="item">Item</label>
    <select id="item" name="item" required>
      <option value="">--Select Item--</option>
    </select>

    <label for="quantity">Quantity</label>
    <div class="quantity-unit">
      <input type="number" id="quantity" name="quantity" min="1" required />
      <span class="unit-label" id="unitLabel"></span>
    </div>

    <label for="reason">Reason</label>
    <select id="reason" name="reason" required>
      <option value="">--Select Reason--</option>
      <option value="Complimentary">Complimentary</option>
      <option value="Pay Later">Pay Later</option>
      <option value="Managers Cup">Managers Cup</option>
      <option value="Personal Use">Personal Use</option>
      <option value="For Maintenance Worker">For Maintenance Worker</option>
      <option value="Badgering-Give and report to manager">Badgering - Give and report to manager</option>
      <option value="Other">Other</option>
    </select>

    <button type="submit">Submit</button>
  </form>

  <!-- Separator -->
  <div class="section-separator"></div>

  <!-- Erase Pay Later Section -->
  <div id="erasePayLaterContainer">
    <button type="button" id="erasePayLaterBtn">Erase Pay Later</button>
  </div>

  <!-- Erase Modal -->
  <div id="eraseModal">
    <h3>Erase Pay Later Items</h3>
    <label>Staff:</label>
    <select id="eraseStaffSelect"></select>
    <div id="payLaterItems" style="margin-top:10px; max-height:260px; overflow-y:auto;"></div>
    <button id="submitErase">Submit</button>
    <button id="closeErase">Cancel</button>
  </div>

<script>
const baseApiUrl = 'https://script.google.com/macros/s/AKfycbxuZrK2k-iL7fAF-xQpWz2PQCf5QndggQZ26OqCoW--f6RHpVYegu-bN0e2Ksskzf68iw/exec'; // <<<<<<<<<<<<<<<<<<<<<<<< REPLACE THIS

const form = document.getElementById('consumptionForm');
const unitLabel = document.getElementById('unitLabel');

// ---------- Load Staff (from Summary) ----------
fetch(baseApiUrl + '?type=staff')
  .then(r => r.json())
  .then(data => {
    const staffSelect = document.getElementById('staff');
    data.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      staffSelect.appendChild(opt);
    });
  });

// ---------- Load Items + Units ----------
let itemsData = [];
fetch(baseApiUrl + '?type=items')
  .then(r => r.json())
  .then(data => {
    itemsData = data; // [ [item, unit], ... ]
    const itemSelect = document.getElementById('item');
    data.forEach(row => {
      const opt = document.createElement('option');
      opt.value = row[0];
      opt.textContent = row[0];
      itemSelect.appendChild(opt);
    });
    itemSelect.addEventListener("change", () => {
      const match = itemsData.find(row => row[0] === itemSelect.value);
      unitLabel.textContent = match ? match[1] : "";
    });
  });

// ---------- Form Submit (ADD) ----------
form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const submitBtn = form.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.textContent = "Submitting...";

  const formData = new URLSearchParams({
    action: 'add',
    date: form.date.value,
    staff: form.staff.value,
    item: form.item.value,
    quantity: form.quantity.value,
    reason: form.reason.value
  });

  try {
    if (navigator.onLine) {
      await fetch(baseApiUrl, { method: 'POST', body: formData });
      alert("Data submitted successfully!");
      form.reset();
      unitLabel.textContent = "";
    } else {
      // offline queue
      let q = JSON.parse(localStorage.getItem('offlineAdd') || '[]');
      q.push(Object.fromEntries(formData));
      localStorage.setItem('offlineAdd', JSON.stringify(q));
      alert("No internet. Saved locally and will sync when online.");
      form.reset();
      unitLabel.textContent = "";
    }
  } catch (err) {
    alert("Error submitting. Try again.");
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = "Submit";
  }
});

// ---------- ONLINE SYNC ----------
window.addEventListener('online', async () => {
  // sync adds
  const adds = JSON.parse(localStorage.getItem('offlineAdd') || '[]');
  for (const a of adds) {
    const p = new URLSearchParams(a);
    await fetch(baseApiUrl, { method: 'POST', body: p });
  }
  if (adds.length) localStorage.removeItem('offlineAdd');

  // sync erases
  const erases = JSON.parse(localStorage.getItem('offlineErase') || '[]');
  for (const er of erases) {
    const p = new URLSearchParams({ action: 'erase', staff: er.staff, items: JSON.stringify(er.items) });
    await fetch(baseApiUrl, { method: 'POST', body: p });
  }
  if (erases.length) localStorage.removeItem('offlineErase');
});

// ---------- Erase Pay Later Modal ----------
const eraseBtn = document.getElementById('erasePayLaterBtn');
const eraseModal = document.getElementById('eraseModal');
const eraseStaffSelect = document.getElementById('eraseStaffSelect');
const payLaterItemsDiv = document.getElementById('payLaterItems');
const submitEraseBtn = document.getElementById('submitErase');
const closeEraseBtn = document.getElementById('closeErase');

eraseBtn.addEventListener('click', async () => {
  submitEraseBtn.disabled = true;
  // load staff
  const staffList = await fetch(baseApiUrl + '?type=staff').then(r => r.json());
  eraseStaffSelect.innerHTML = `<option value="">-- Select Staff --</option>` +
    staffList.map(s => `<option value="${s}">${s}</option>`).join('');
  payLaterItemsDiv.innerHTML = "";
  eraseModal.style.display = "block";
});

eraseStaffSelect.addEventListener('change', async function () {
  const staffName = this.value;
  submitEraseBtn.disabled = true;
  payLaterItemsDiv.innerHTML = "";

  if (!staffName) return;

  const list = await fetch(baseApiUrl + '?type=paylater&staff=' + encodeURIComponent(staffName)).then(r => r.json());
  if (!list.length) {
    payLaterItemsDiv.innerHTML = "<p>No Pay Later items.</p>";
    return;
  }

  // Render: checkbox + qty (max = outstanding)
  const html = list.map(p => `
    <div class="row">
      <input type="checkbox" class="erase-chk" value="${p.item}" data-unit="${p.unit}" data-max="${p.quantity}">
      <label>${p.item} (${p.quantity} ${p.unit})</label>
      <input type="number" class="erase-qty" min="1" max="${p.quantity}" placeholder="Qty" disabled>
    </div>
  `).join('');
  payLaterItemsDiv.innerHTML = html;
});

// Event delegation for enabling qty and button state
payLaterItemsDiv.addEventListener('change', (e) => {
  if (e.target.classList.contains('erase-chk')) {
    const row = e.target.closest('.row');
    const qty = row.querySelector('.erase-qty');
    qty.disabled = !e.target.checked;
    if (!e.target.checked) qty.value = '';
  }

  // enable submit if any checked & qty>0
  let ok = false;
  document.querySelectorAll('#payLaterItems .row').forEach(r => {
    const chk = r.querySelector('.erase-chk');
    const qty = r.querySelector('.erase-qty');
    if (chk.checked && Number(qty.value) > 0) ok = true;
  });
  submitEraseBtn.disabled = !ok;
});

payLaterItemsDiv.addEventListener('input', (e) => {
  if (!e.target.classList.contains('erase-qty')) return;
  const max = Number(e.target.getAttribute('max')) || 0;
  let v = Number(e.target.value) || 0;
  if (v > max) { v = max; e.target.value = v; }

  let ok = false;
  document.querySelectorAll('#payLaterItems .row').forEach(r => {
    const chk = r.querySelector('.erase-chk');
    const qty = r.querySelector('.erase-qty');
    if (chk.checked && Number(qty.value) > 0) ok = true;
  });
  submitEraseBtn.disabled = !ok;
});

// Submit Erase
submitEraseBtn.addEventListener('click', async function () {
  const originalText = submitEraseBtn.textContent;
  submitEraseBtn.disabled = true;
  submitEraseBtn.textContent = "Erasing...";

  const staff = eraseStaffSelect.value;
  if (!staff) {
    alert("Select staff.");
    submitEraseBtn.disabled = false;
    submitEraseBtn.textContent = originalText;
    return;
  }

  const rows = document.querySelectorAll('#payLaterItems .row');
  const items = [];
  rows.forEach(r => {
    const chk = r.querySelector('.erase-chk');
    const qty = r.querySelector('.erase-qty');
    if (chk.checked) {
      const want = Number(qty.value) || 0;
      const max = Number(chk.getAttribute('data-max')) || 0;
      if (want > 0) {
        const use = Math.min(want, max); // safety
        items.push({ item: chk.value, quantity: use });
      }
    }
  });

  if (!items.length) {
    alert("Select at least one item with quantity.");
    submitEraseBtn.disabled = false;
    submitEraseBtn.textContent = originalText;
    return;
  }

  try {
    if (navigator.onLine) {
      await fetch(baseApiUrl, {
        method: 'POST',
        body: new URLSearchParams({
          action: 'erase',
          staff,
          items: JSON.stringify(items)
        })
      });
      alert("Pay Later items erased successfully!");
    } else {
      // offline queue
      let q = JSON.parse(localStorage.getItem('offlineErase') || '[]');
      q.push({ staff, items });
      localStorage.setItem('offlineErase', JSON.stringify(q));
      alert("No internet. Erase saved locally and will sync when online.");
    }
    eraseModal.style.display = "none";
  } catch (err) {
    alert("Error submitting erase.");
  } finally {
    submitEraseBtn.disabled = false;
    submitEraseBtn.textContent = originalText;
  }
});

// Close modal
closeEraseBtn.addEventListener('click', () => {
  eraseModal.style.display = "none";
});
</script>
</body>
</html>
