<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Staff Consumption Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0078d4" />
<style>
  body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: #f8f9fa;
    padding: 20px;
    margin: 0;
  }
  h2 {
    text-align: center;
    color: #333;
  }
  form {
    max-width: 400px;
    margin: auto;
    background: #fff;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  label {
    display: block;
    margin-top: 15px;
    font-weight: 600;
    font-size: 0.9rem;
    color: #333;
  }
  input, select, textarea {
    width: 100%;
    padding: 0.45rem 0.5rem;
    margin-top: 5px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 1rem;
    box-sizing: border-box;
    transition: border-color 0.2s;
  }
  input:focus, select:focus, textarea:focus {
    border-color: #0078d4;
    outline: none;
  }
  .quantity-unit {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .quantity-unit input {
    flex: 1;
  }
  .unit-label {
    white-space: nowrap;
    font-size: 0.9rem;
    color: #555;
    min-width: 40px;
  }

  /* Submit Button */
  form button[type="submit"] {
    width: 100%;
    background: orange;
    color: white;
    border: none;
    padding: 0.7rem;
    border-radius: 5px;
    font-size: 1.1rem;
    margin-top: 15px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: background 0.3s;
    position: relative;
    z-index: 10;
  }
  form button[type="submit"]:hover {
    background: #e69500;
  }

  /* Separator between sections */
  .section-separator {
    max-width: 400px;
    margin: 30px auto;
    border-top: 2px solid #ddd;
  }

  /* Erase Pay Later container */
  #erasePayLaterContainer {
    max-width: 400px;
    margin: 20px auto;
    position: relative;
    z-index: 1;
  }
  #erasePayLaterBtn {
    width: 100%;
    background: #dc3545;
    color: white;
    border: none;
    padding: 0.7rem;
    border-radius: 5px;
    font-size: 1.1rem;
    cursor: pointer;
    transition: background 0.3s;
  }
  #erasePayLaterBtn:hover {
    background: #b02a37;
  }

  @media (max-width: 480px) {
    form {
      padding: 1rem;
    }
  }
</style>
</head>
<body>

  <h2>Staff Daily Consumption</h2>

  <!-- Form Section -->
  <form id="consumptionForm">
    <label for="date">Date</label>
    <input type="date" id="date" name="date" required />

    <label for="staff">Staff</label>
    <select id="staff" name="staff" required>
      <option value="">--Select Staff--</option>
    </select>

    <label for="item">Item</label>
    <select id="item" name="item" required>
      <option value="">--Select Item--</option>
    </select>

    <label for="quantity">Quantity</label>
    <div class="quantity-unit">
      <input type="number" id="quantity" name="quantity" min="1" required />
      <span class="unit-label" id="unitLabel"></span>
    </div>

    <label for="reason">Reason</label>
    <select id="reason" name="reason" required>
      <option value="">--Select Reason--</option>
      <option value="Complimentary">Complimentary</option>
      <option value="Pay Later">Pay Later</option>
      <option value="Managers Cup">Managers Cup</option>
      <option value="Personal Use">Personal Use</option>
      <option value="For Maintenance Worker">For Maintenance Worker</option>
      <option value="Badgering-Give and report to manager">Badgering - Give and report to manager</option>
      <option value="Other">Other</option>
    </select>

    <button type="submit">Submit</button>
  </form>

  <!-- Separator -->
  <div class="section-separator"></div>

  <!-- Erase Pay Later Section -->
  <div id="erasePayLaterContainer">
    <button type="button" id="erasePayLaterBtn">Erase Pay Later</button>
  </div>

  <!-- Erase Modal -->
  <div id="eraseModal" style="display:none; position:fixed; top:20%; left:30%; background:#fff; padding:20px; border:1px solid #ccc; z-index:1000;">
    <h3>Erase Pay Later Items</h3>
    <label>Staff:</label>
    <select id="eraseStaffSelect"></select>
    
    <div id="payLaterItems" style="margin-top:10px; max-height:200px; overflow-y:auto;"></div>

    <button id="submitErase">Submit</button>
    <button id="closeErase">Cancel</button>
  </div>

<script>
  const form = document.getElementById('consumptionForm');
  const baseApiUrl = 'https://script.google.com/macros/s/AKfycbx8N8XbkKthFtjBpH70LATLH9kEVVbSJp2MB4QecZ26TsCZLuHfaU9J_IsRcJiWFHcacQ/exec';
  const staffApiUrl = baseApiUrl + '?type=staff';
  const itemsApiUrl = baseApiUrl + '?type=items';

  // Load staff
  fetch(staffApiUrl)
    .then(r => r.json())
    .then(data => {
      const staffSelect = document.getElementById('staff');
      data.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        staffSelect.appendChild(opt);
      });
    });

  // Load items + units
  let itemsData = [];
  let unitLabel = document.getElementById('unitLabel');

  fetch(itemsApiUrl)
    .then(r => r.json())
    .then(data => {
      itemsData = data;
      const itemSelect = document.getElementById('item');
      data.forEach(row => {
        const opt = document.createElement('option');
        opt.value = row[0];
        opt.textContent = row[0];
        itemSelect.appendChild(opt);
      });
      itemSelect.addEventListener("change", () => {
        let match = itemsData.find(row => row[0] === itemSelect.value);
        unitLabel.textContent = match ? match[1] : "";
      });
    });

  // Handle submit
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

// --- BUTTON DISABLE/ENABLE ADDED ---
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = "Submitting..."; // optional visual feedback
    // --- END CHANGE ---

    const formData = {
      date: form.date.value,
      staff: form.staff.value,
      item: form.item.value,
      quantity: form.quantity.value,
      reason: form.reason.value
    };

    if (navigator.onLine) {
      await fetch(baseApiUrl, {
        method: 'POST',
        body: new URLSearchParams(formData)
      });
      alert("Data submitted successfully!");
      form.reset();
    } else {
      let offlineData = JSON.parse(localStorage.getItem('offlineSubmissions') || '[]');
      offlineData.push(formData);
      localStorage.setItem('offlineSubmissions', JSON.stringify(offlineData));
      alert("No internet. Data saved locally and will be sent when online.");
      form.reset();
    }

 // --- RE-ENABLE BUTTON AFTER SUBMISSION ---
    submitBtn.disabled = false;
    submitBtn.textContent = "Submit";
    // --- END CHANGE ---

  });

  // Erase Pay Later
  document.getElementById("erasePayLaterBtn").addEventListener("click", async function() {
    let submitBtn = document.getElementById("submitErase");
    submitBtn.disabled = true;

    let staffList = await fetch(baseApiUrl + "?type=staff").then(r => r.json());
    let staffSelect = document.getElementById("eraseStaffSelect");
    staffSelect.innerHTML = `<option value="">-- Select Staff --</option>` + 
      staffList.map(s => `<option value="${s}">${s}</option>`).join("");

    document.getElementById("payLaterItems").innerHTML = "";
    document.getElementById("eraseModal").style.display = "block";
  });

  document.getElementById("eraseStaffSelect").addEventListener("change", async function() {
    let staffName = this.value;
    let submitBtn = document.getElementById("submitErase");
    submitBtn.disabled = true;

    if (!staffName) {
      document.getElementById("payLaterItems").innerHTML = "";
      return;
    }

    let payLater = await fetch(baseApiUrl + "?type=paylater&staff=" + encodeURIComponent(staffName))
      .then(r => r.json());

    let html = payLater.map(p => 
      `<label>
        <input type="checkbox" value="${p.item}"> ${p.item} (${p.quantity} ${p.unit})
      </label><br>`
    ).join("");

    document.getElementById("payLaterItems").innerHTML = html || "<p>No Pay Later items.</p>";

    document.querySelectorAll("#payLaterItems input[type='checkbox']").forEach(cb => {
      cb.addEventListener("change", function() {
        let itemsChecked = document.querySelectorAll("#payLaterItems input:checked").length;
        submitBtn.disabled = !(staffName && itemsChecked > 0);
      });
    });
  });

  document.getElementById("submitErase").addEventListener("click", async function() {
    let staffName = document.getElementById("eraseStaffSelect").value;
    let items = [...document.querySelectorAll("#payLaterItems input:checked")].map(cb => cb.value);

    if (items.length === 0) {
      alert("Select at least one item.");
      return;
    }

    let formData = new URLSearchParams();
    formData.append("action", "erase");
    formData.append("staff", staffName);
    formData.append("items", JSON.stringify(items));

    let res = await fetch(baseApiUrl, { method: "POST", body: formData });
    alert(await res.text());
    document.getElementById("eraseModal").style.display = "none";
  });

  document.getElementById("closeErase").addEventListener("click", function() {
    document.getElementById("eraseModal").style.display = "none";
  });

  window.addEventListener('online', async () => {
    let offlineData = JSON.parse(localStorage.getItem('offlineSubmissions') || '[]');
    if (offlineData.length > 0) {
      for (const data of offlineData) {
        await fetch(baseApiUrl, {
          method: 'POST',
          body: new URLSearchParams(data)
        });
      }
      localStorage.removeItem('offlineSubmissions');
      alert("Offline data synced to server.");
    }
  });
</script>

</body>
</html>
